{% extends "base.html" %}

{% block title %}Configuration Initiale - Grabb2RSS{% endblock %}

{% block content %}
    <div class="container">
        <header>
            <h1>üöÄ Bienvenue sur grabb2RSS</h1>
            <p class="subtitle">Configuration initiale - Version 2.6.5</p>
        </header>

        <div id="alert" class="alert"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #888;">Validation et sauvegarde en cours...</p>
        </div>

        <form id="setupForm">
            <!-- Prowlarr (Obligatoire) -->
            <div class="section">
                <div class="section-title">üîç Prowlarr (Obligatoire)</div>
                <div class="form-group">
                    <label>
                        URL de Prowlarr <span class="required">*</span>
                    </label>
                    <input type="url" id="prowlarr_url" name="prowlarr_url"
                           value="http://prowlarr:9696" placeholder="http://prowlarr:9696" required>
                    <div class="help-text">
                        URL compl√®te de votre instance Prowlarr (avec le port)
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        Cl√© API Prowlarr <span class="required">*</span>
                    </label>
                    <input type="text" id="prowlarr_api_key" name="prowlarr_api_key"
                           placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                    <div class="help-text">
                        Prowlarr &gt; Param√®tres &gt; G√©n√©ral &gt; S√©curit√©
                    </div>
                </div>
                <div class="form-group">
                    <label>Taille de l'historique</label>
                    <input type="number" id="prowlarr_history_page_size"
                           name="prowlarr_history_page_size" value="500" min="100" max="1000">
                    <div class="help-text">Nombre de grabs √† r√©cup√©rer par sync (d√©faut: 500)</div>
                </div>
            </div>

            <!-- Radarr (Obligatoire) -->
            <div class="section">
                <div class="section-title">üé¨ Radarr (Obligatoire)</div>
                <div class="form-group">
                    <label>
                        URL de Radarr <span class="required">*</span>
                    </label>
                    <input type="url" id="radarr_url" name="radarr_url"
                           value="http://radarr:7878" placeholder="http://radarr:7878" required>
                    <div class="help-text">URL compl√®te de votre instance Radarr</div>
                </div>
                <div class="form-group">
                    <label>
                        Cl√© API Radarr <span class="required">*</span>
                    </label>
                    <input type="text" id="radarr_api_key" name="radarr_api_key"
                           placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                    <div class="help-text">Radarr &gt; Param√®tres &gt; G√©n√©ral &gt; S√©curit√©</div>
                </div>
            </div>

            <!-- Sonarr (Obligatoire) -->
            <div class="section">
                <div class="section-title">üì∫ Sonarr (Obligatoire)</div>
                <div class="form-group">
                    <label>
                        URL de Sonarr <span class="required">*</span>
                    </label>
                    <input type="url" id="sonarr_url" name="sonarr_url"
                           value="http://sonarr:8989" placeholder="http://sonarr:8989" required>
                    <div class="help-text">URL compl√®te de votre instance Sonarr</div>
                </div>
                <div class="form-group">
                    <label>
                        Cl√© API Sonarr <span class="required">*</span>
                    </label>
                    <input type="text" id="sonarr_api_key" name="sonarr_api_key"
                           placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                    <div class="help-text">Sonarr &gt; Param√®tres &gt; G√©n√©ral &gt; S√©curit√©</div>
                </div>
            </div>

            <!-- Param√®tres avanc√©s -->
            <div class="section">
                <div class="section-title">‚öôÔ∏è Param√®tres</div>
                <div class="form-group">
                    <label>Intervalle de synchronisation (secondes)</label>
                    <input type="number" id="sync_interval" name="sync_interval" value="3600">
                    <div class="help-text">Fr√©quence de synchronisation avec Prowlarr (3600 = 1 heure)</div>
                </div>
                <div class="form-group">
                    <label>R√©tention des torrents (heures)</label>
                    <input type="number" id="retention_hours" name="retention_hours" value="168">
                    <div class="help-text">Dur√©e de conservation des torrents (168 = 7 jours)</div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="auto_purge" name="auto_purge" checked>
                    <label for="auto_purge" style="margin: 0;">
                        Purge automatique des anciens torrents
                    </label>
                </div>
            </div>

            <!-- Section: Authentification -->
            <div class="section">
                <div class="section-title">üîê Authentification (Optionnel mais Recommand√©)</div>
                <div class="alert-info" style="background: #003366; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1e90ff;">
                    <strong>üí° Protection de votre interface</strong><br>
                    <span style="font-size: 13px; color: #ddd;">
                        Activez l'authentification pour prot√©ger l'acc√®s √† votre interface web.
                        Les flux RSS locaux resteront accessibles sans authentification,
                        mais vous pourrez g√©n√©rer des API Keys pour l'acc√®s externe.
                    </span>
                </div>
                <div class="checkbox-group" style="margin-bottom: 20px;">
                    <input type="checkbox" id="auth_enabled" name="auth_enabled" onchange="toggleAuthFields()">
                    <label for="auth_enabled" style="margin: 0; font-weight: 600; color: #1e90ff;">
                        ‚úÖ Activer l'authentification
                    </label>
                </div>
                <div id="auth_fields" style="display: none;">
                    <div class="form-group">
                        <label>Nom d'utilisateur <span class="required">*</span></label>
                        <input type="text" id="auth_username" name="auth_username"
                               placeholder="admin" autocomplete="username">
                        <div class="help-text">Choisissez un nom d'utilisateur pour vous connecter</div>
                    </div>
                    <div class="form-group">
                        <label>Mot de passe <span class="required">*</span></label>
                        <input type="password" id="auth_password" name="auth_password"
                               placeholder="Mot de passe s√©curis√©" autocomplete="new-password">
                        <div class="help-text">Minimum 8 caract√®res recommand√©s</div>
                    </div>
                </div>
            </div>

            <!-- Boutons -->
            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="testConnection()">
                    üîå Tester la connexion
                </button>
                <button type="submit" class="btn-primary">
                    ‚úÖ Enregistrer et d√©marrer
                </button>
            </div>
        </form>
    </div>

    <script>
        // Toggle auth fields visibility
        function toggleAuthFields() {
            const authEnabled = document.getElementById('auth_enabled').checked;
            const authFields = document.getElementById('auth_fields');
            authFields.style.display = authEnabled ? 'block' : 'none';

            // Rendre les champs required si l'auth est activ√©e
            const usernameField = document.getElementById('auth_username');
            const passwordField = document.getElementById('auth_password');

            if (authEnabled) {
                usernameField.setAttribute('required', 'required');
                passwordField.setAttribute('required', 'required');
            } else {
                usernameField.removeAttribute('required');
                passwordField.removeAttribute('required');
            }
        }

        // Test connection
        async function testConnection() {
            const url = document.getElementById('prowlarr_url').value;
            const apiKey = document.getElementById('prowlarr_api_key').value;

            if (!url || !apiKey) {
                showAlert("Veuillez remplir l'URL et la cl√© API Prowlarr", 'error');
                return;
            }

            showAlert('Test de connexion en cours...', 'success');

            try {
                const response = await fetch('/api/setup/test-prowlarr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, api_key: apiKey })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Connexion r√©ussie √† Prowlarr !', 'success');
                } else {
                    showAlert('Erreur: ' + (data.error || 'Connexion √©chou√©e'), 'error');
                }
            } catch (error) {
                showAlert('Erreur de connexion: ' + error.message, 'error');
            }
        }

        // Submit form
        document.getElementById('setupForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const config = {
                prowlarr_url: formData.get('prowlarr_url'),
                prowlarr_api_key: formData.get('prowlarr_api_key'),
                prowlarr_history_page_size: parseInt(formData.get('prowlarr_history_page_size')),

                radarr_enabled: true,
                radarr_url: formData.get('radarr_url'),
                radarr_api_key: formData.get('radarr_api_key'),

                sonarr_enabled: true,
                sonarr_url: formData.get('sonarr_url'),
                sonarr_api_key: formData.get('sonarr_api_key'),

                sync_interval: parseInt(formData.get('sync_interval')),
                retention_hours: parseInt(formData.get('retention_hours')),
                auto_purge: document.getElementById('auto_purge').checked,
                dedup_hours: 168,

                rss_domain: window.location.hostname,
                rss_scheme: window.location.protocol.replace(':', ''),
                rss_title: 'grabb2RSS',
                rss_description: 'Prowlarr to RSS Feed',

                // Authentification
                auth_enabled: document.getElementById('auth_enabled').checked,
                auth_username: formData.get('auth_username') || '',
                auth_password: formData.get('auth_password') || ''
            };

            // Validation de l'authentification si activ√©e
            if (config.auth_enabled) {
                if (!config.auth_username || !config.auth_password) {
                    showAlert('Veuillez remplir le nom d\'utilisateur et le mot de passe pour l\'authentification', 'error');
                    return;
                }
                if (config.auth_password.length < 8) {
                    showAlert('Le mot de passe doit contenir au moins 8 caract√®res', 'error');
                    return;
                }
            }

            // Show loading
            document.getElementById('setupForm').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch('/api/setup/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Configuration enregistr√©e ! Redirection...', 'success');
                    setTimeout(function() {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    document.getElementById('setupForm').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    showAlert('Erreur: ' + (data.error || data.message || 'Impossible de sauvegarder'), 'error');
                }
            } catch (error) {
                document.getElementById('setupForm').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                showAlert('Erreur: ' + error.message, 'error');
            }
        });

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert ' + type;
            alert.style.display = 'block';

            if (type === 'success' && !message.includes('Test')) {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }
    </script>
{% endblock %}

{% block scripts %}
<script>
        // V√©rifier si le setup est d√©j√† termin√© au chargement de la page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/setup/status');
                const data = await res.json();

                // Si le setup est d√©j√† termin√©, rediriger vers le dashboard
                if (!data.first_run && data.config_exists) {
                    console.log("‚úÖ Setup d√©j√† termin√© - redirection vers /");
                    window.location.href = '/';
                    return;
                }
            } catch (error) {
                console.error("Erreur v√©rification setup status:", error);
                // Continuer l'affichage de la page m√™me en cas d'erreur
            }
        });

        // Toggle auth fields visibility
        function toggleAuthFields() {
            const authEnabled = document.getElementById('auth_enabled').checked;
            const authFields = document.getElementById('auth_fields');
            authFields.style.display = authEnabled ? 'block' : 'none';

            // Rendre les champs required si l'auth est activ√©e
            const usernameField = document.getElementById('auth_username');
            const passwordField = document.getElementById('auth_password');

            if (authEnabled) {
                usernameField.setAttribute('required', 'required');
                passwordField.setAttribute('required', 'required');
            } else {
                usernameField.removeAttribute('required');
                passwordField.removeAttribute('required');
            }
        }

        // Test connection
        async function testConnection() {
            const url = document.getElementById('prowlarr_url').value;
            const apiKey = document.getElementById('prowlarr_api_key').value;

            if (!url || !apiKey) {
                showAlert("Veuillez remplir l'URL et la cl√© API Prowlarr", 'error');
                return;
            }

            showAlert('Test de connexion en cours...', 'success');

            try {
                const response = await fetch('/api/setup/test-prowlarr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, api_key: apiKey })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Connexion r√©ussie √† Prowlarr !', 'success');
                } else {
                    showAlert('Erreur: ' + (data.error || 'Connexion √©chou√©e'), 'error');
                }
            } catch (error) {
                showAlert('Erreur de connexion: ' + error.message, 'error');
            }
        }

        // Submit form
        document.getElementById('setupForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const config = {
                prowlarr_url: formData.get('prowlarr_url'),
                prowlarr_api_key: formData.get('prowlarr_api_key'),
                prowlarr_history_page_size: parseInt(formData.get('prowlarr_history_page_size')),

                radarr_enabled: true,
                radarr_url: formData.get('radarr_url'),
                radarr_api_key: formData.get('radarr_api_key'),

                sonarr_enabled: true,
                sonarr_url: formData.get('sonarr_url'),
                sonarr_api_key: formData.get('sonarr_api_key'),

                sync_interval: parseInt(formData.get('sync_interval')),
                retention_hours: parseInt(formData.get('retention_hours')),
                auto_purge: document.getElementById('auto_purge').checked,
                dedup_hours: 168,

                rss_domain: window.location.hostname,
                rss_scheme: window.location.protocol.replace(':', ''),
                rss_title: 'grabb2RSS',
                rss_description: 'Prowlarr to RSS Feed',

                // Authentification
                auth_enabled: document.getElementById('auth_enabled').checked,
                auth_username: formData.get('auth_username') || '',
                auth_password: formData.get('auth_password') || ''
            };

            // Validation de l'authentification si activ√©e
            if (config.auth_enabled) {
                if (!config.auth_username || !config.auth_password) {
                    showAlert('Veuillez remplir le nom d\'utilisateur et le mot de passe pour l\'authentification', 'error');
                    return;
                }
                if (config.auth_password.length < 8) {
                    showAlert('Le mot de passe doit contenir au moins 8 caract√®res', 'error');
                    return;
                }
            }

            // Show loading
            document.getElementById('setupForm').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch('/api/setup/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Configuration enregistr√©e ! Redirection...', 'success');
                    setTimeout(function() {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    document.getElementById('setupForm').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    showAlert('Erreur: ' + (data.error || data.message || 'Impossible de sauvegarder'), 'error');
                }
            } catch (error) {
                document.getElementById('setupForm').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                showAlert('Erreur: ' + error.message, 'error');
            }
        });

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert ' + type;
            alert.style.display = 'block';

            if (type === 'success' && !message.includes('Test')) {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }
</script>
{% endblock %}
