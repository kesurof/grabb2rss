{% extends "base.html" %}

{% block title %}Grabb2RSS - Interface de Gestion{% endblock %}

{% block content %}
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸ“¡ Grabb2RSS v2.6.8</h1>
                    <p class="subtitle">Convertisseur Prowlarr â†’ RSS avec Flux PersonnalisÃ©s + Admin</p>
                </div>
                <div id="auth-info" style="display: none; text-align: right;">
                    <p style="color: #888; font-size: 13px; margin-bottom: 5px;">
                        ConnectÃ© en tant que: <span id="username-display" style="color: #1e90ff; font-weight: 600;"></span>
                    </p>
                    <button class="button" onclick="logout()" style="font-size: 13px; padding: 8px 15px;">
                        ğŸšª DÃ©connexion
                    </button>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard')">ğŸ“Š Dashboard</button>
            <button class="tab-button" onclick="switchTab('grabs')">ğŸ“‹ Grabs</button>
            <button class="tab-button" onclick="switchTab('torrents')">ğŸ“¦ Torrents</button>
            <button class="tab-button" onclick="switchTab('stats')">ğŸ“ˆ Statistiques</button>
            <button class="tab-button" onclick="switchTab('rss')">ğŸ“¡ Flux RSS</button>
            <button class="tab-button" onclick="switchTab('logs')">ğŸ“ Logs</button>
            <button class="tab-button" onclick="switchTab('config')">âš™ï¸ Configuration</button>
            <button class="tab-button" onclick="switchTab('security')" id="security-tab" style="display: none;">ğŸ” SÃ©curitÃ©</button>
            <button class="tab-button" onclick="switchTab('admin')">ğŸ”§ Admin</button>
        </div>

        <!-- TAB: DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="alert info" style="margin-bottom: 20px;">
                <strong>ğŸ‘‹ Bienvenue sur Grab2RSS v2.6.8</strong><br>
                <span style="color: #ddd;">Votre convertisseur Prowlarr â†’ RSS est opÃ©rationnel. Surveillez vos grabs, gÃ©rez vos torrents et configurez vos flux RSS personnalisÃ©s.</span>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>ğŸ“‹ Total Grabs</h3>
                    <div class="value" id="total-grabs">-</div>
                    <p style="color: #888; font-size: 12px; margin-top: 10px;">Grabs enregistrÃ©s en base</p>
                </div>
                <div class="card">
                    <h3>ğŸ“¦ Fichiers Torrents</h3>
                    <div class="value" id="dashboard-torrent-count">-</div>
                    <p style="color: #888; font-size: 12px; margin-top: 10px;">
                        Taille: <span id="dashboard-torrent-size">-</span> MB
                    </p>
                </div>
                <div class="card">
                    <h3>ğŸ’¾ Stockage Total</h3>
                    <div class="value"><span id="storage-size">-</span><span class="unit">MB</span></div>
                    <p style="color: #888; font-size: 12px; margin-top: 10px;">Base + Torrents</p>
                </div>
                <div class="card">
                    <h3>ğŸ“¡ Statut Sync</h3>
                    <div class="status" id="sync-status"></div>
                    <div class="date" id="next-sync" style="margin-top: 10px;">-</div>
                </div>
            </div>

            <div class="grid" style="margin-top: 20px;">
                <div class="card">
                    <h3>ğŸ•’ Dernier Grab</h3>
                    <div class="value" id="latest-grab" style="font-size: 14px; margin-top: 10px;">-</div>
                </div>
                <div class="card">
                    <h3>ğŸ¯ Trackers Actifs</h3>
                    <div class="value" id="dashboard-trackers-count">-</div>
                    <p style="color: #888; font-size: 12px; margin-top: 10px;">Trackers diffÃ©rents</p>
                </div>
                <div class="card">
                    <h3>ğŸ“Š Grabs Aujourd'hui</h3>
                    <div class="value" id="dashboard-grabs-today">-</div>
                    <p style="color: #888; font-size: 12px; margin-top: 10px;">DerniÃ¨res 24h</p>
                </div>
                <div class="card">
                    <h3>â±ï¸ Uptime</h3>
                    <div class="value" id="dashboard-uptime" style="font-size: 20px;">-</div>
                    <p style="color: #888; font-size: 12px; margin-top: 10px;">Temps d'activitÃ©</p>
                </div>
            </div>

            <h2>ğŸ¯ Actions Rapides</h2>
            <div class="actions">
                <button class="button" onclick="refreshData()">ğŸ”„ Actualiser Dashboard</button>
                <button class="button success" id="sync-btn" onclick="syncNow()">ğŸ“¡ Synchroniser Maintenant</button>
                <button class="button" onclick="switchTab('torrents')">ğŸ“¦ GÃ©rer les Torrents</button>
                <button class="button danger" onclick="purgeAllGrabs()">ğŸ—‘ï¸ Vider Tous les Grabs</button>
            </div>

            <h2 style="margin-top: 30px;">ğŸ”— AccÃ¨s Rapides</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <a href="/rss" target="_blank" style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; text-decoration: none; color: #1e90ff; display: block; transition: 0.2s;">
                    <strong style="display: block; margin-bottom: 5px;">ğŸ“¡ Flux RSS Global</strong>
                    <span style="color: #888; font-size: 12px;">Tous les trackers</span>
                </a>
                <a href="/api/stats" target="_blank" style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; text-decoration: none; color: #1e90ff; display: block; transition: 0.2s;">
                    <strong style="display: block; margin-bottom: 5px;">ğŸ“Š Statistiques API</strong>
                    <span style="color: #888; font-size: 12px;">Format JSON</span>
                </a>
                <a href="/health" target="_blank" style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; text-decoration: none; color: #1e90ff; display: block; transition: 0.2s;">
                    <strong style="display: block; margin-bottom: 5px;">ğŸ’š Health Check</strong>
                    <span style="color: #888; font-size: 12px;">Ã‰tat des services</span>
                </a>
                <a href="javascript:void(0)" onclick="switchTab('config')" style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; text-decoration: none; color: #1e90ff; display: block; transition: 0.2s;">
                    <strong style="display: block; margin-bottom: 5px;">âš™ï¸ Configuration</strong>
                    <span style="color: #888; font-size: 12px;">Modifier les paramÃ¨tres</span>
                </a>
            </div>
        </div>

        <!-- TAB: GRABS -->
        <div id="grabs" class="tab-content">
            <h2>ğŸ“‹ Derniers Grabs</h2>

            <div class="filter-bar">
                <label for="tracker-filter-grabs" style="margin: 0; color: #1e90ff; font-weight: 600;">Filtrer par Tracker:</label>
                <select id="tracker-filter-grabs" onchange="filterGrabs()" style="flex: 0 0 auto; min-width: 200px;">
                    <option value="all">Tous les trackers</option>
                </select>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Titre</th>
                        <th>Tracker</th>
                        <th>Fichier</th>
                    </tr>
                </thead>
                <tbody id="grabs-table">
                    <tr><td colspan="4" style="text-align: center; color: #888;">Chargement...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- TAB: TORRENTS -->
        <div id="torrents" class="tab-content">
            <h2>ğŸ“¦ Gestion des Fichiers Torrents</h2>
            <p style="color: #888; margin-bottom: 20px;">GÃ©rez vos fichiers torrents : tÃ©lÃ©chargement, suppression, nettoyage des orphelins</p>

            <div class="grid" style="margin-bottom: 20px;">
                <div class="card">
                    <h3>Total Fichiers</h3>
                    <div class="value" id="torrents-total">-</div>
                </div>
                <div class="card">
                    <h3>Taille Totale</h3>
                    <div class="value"><span id="torrents-size">-</span><span class="unit">MB</span></div>
                </div>
                <div class="card">
                    <h3>Avec Grab</h3>
                    <div class="value" id="torrents-with-grab">-</div>
                </div>
                <div class="card">
                    <h3>Orphelins</h3>
                    <div class="value" id="torrents-orphans" style="color: #ff6b6b;">-</div>
                </div>
            </div>

            <div class="actions" style="margin-bottom: 20px;">
                <button class="button" onclick="loadTorrents()">ğŸ”„ Actualiser</button>
                <button class="button" onclick="cleanupOrphanTorrents()">ğŸ—‘ï¸ Nettoyer Orphelins</button>
                <button class="button danger" onclick="purgeAllTorrents()">ğŸ—‘ï¸ Vider Tous les Torrents</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="select-all-torrents" onchange="toggleAllTorrents()"></th>
                        <th>Fichier</th>
                        <th>Titre</th>
                        <th>Tracker</th>
                        <th>Date Grab</th>
                        <th>Taille</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="torrents-table">
                    <tr><td colspan="8" style="text-align: center; color: #888;">Chargement...</td></tr>
                </tbody>
            </table>

            <div class="actions" style="margin-top: 20px;" id="bulk-actions" style="display: none;">
                <button class="button danger" onclick="deleteBulkTorrents()">ğŸ—‘ï¸ Supprimer la sÃ©lection</button>
            </div>
        </div>

        <!-- TAB: STATISTIQUES -->
        <div id="stats" class="tab-content">
            <h2>ğŸ“ˆ Statistiques DÃ©taillÃ©es</h2>
            
            <div class="stats-grid">
                <div class="chart-container chart-small">
                    <canvas id="trackerChart"></canvas>
                </div>
                <div class="chart-container chart-small">
                    <canvas id="grabsByDayChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="topTorrentsChart"></canvas>
            </div>
            
            <h3 style="margin-top: 40px; margin-bottom: 15px;">ğŸ“Š Grabs par Tracker</h3>
            <table id="tracker-stats-table">
                <thead>
                    <tr>
                        <th>Tracker</th>
                        <th>Nombre de grabs</th>
                        <th>Pourcentage</th>
                    </tr>
                </thead>
                <tbody id="tracker-stats-body">
                    <tr><td colspan="3" style="text-align: center; color: #888;">Chargement...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- TAB: RSS FEEDS -->
        <div id="rss" class="tab-content">
            <h2>ğŸ“¡ Flux RSS PersonnalisÃ©s</h2>
            <p style="color: #888; margin-bottom: 20px;">Copiez l'URL appropriÃ©e pour votre client torrent</p>
            
            <div class="rss-section">
                <h3>ğŸ¯ Flux Global (Tous les Trackers)</h3>
                <p style="color: #888; font-size: 12px; margin-bottom: 10px;">Compatible rutorrent, qBittorrent, Transmission</p>
                
                <p style="margin-bottom: 10px; color: #ddd;"><strong>Format XML:</strong></p>
                <div class="rss-url" id="rss-global-xml">https://example.com/rss</div>
                <button class="copy-btn" onclick="copyToClipboard('rss-global-xml')">ğŸ“‹ Copier</button>
                
                <p style="margin-top: 15px; margin-bottom: 10px; color: #ddd;"><strong>Format JSON:</strong></p>
                <div class="rss-url" id="rss-global-json">https://example.com/rss/torrent.json</div>
                <button class="copy-btn" onclick="copyToClipboard('rss-global-json')">ğŸ“‹ Copier</button>
            </div>
            
            <div class="rss-section">
                <h3>ğŸ” Flux par Tracker</h3>
                <p style="color: #888; font-size: 12px; margin-bottom: 15px;">SÃ©lectionnez un tracker pour gÃ©nÃ©rer son flux personnalisÃ©</p>
                
                <div class="filter-bar">
                    <label for="tracker-filter-rss" style="margin: 0;">Tracker:</label>
                    <select id="tracker-filter-rss" onchange="updateTrackerRssUrls()" style="flex: 0 0 auto; min-width: 250px;">
                        <option value="all">Tous</option>
                    </select>
                </div>
                
                <p style="margin-bottom: 10px; color: #ddd;"><strong>Format XML:</strong></p>
                <div class="rss-url" id="rss-tracker-xml">-</div>
                <button class="copy-btn" onclick="copyToClipboard('rss-tracker-xml')">ğŸ“‹ Copier</button>
                
                <p style="margin-top: 15px; margin-bottom: 10px; color: #ddd;"><strong>Format JSON:</strong></p>
                <div class="rss-url" id="rss-tracker-json">-</div>
                <button class="copy-btn" onclick="copyToClipboard('rss-tracker-json')">ğŸ“‹ Copier</button>
            </div>
            
            <div class="alert alert-info">
                <strong>ğŸ’¡ Utilisation:</strong> Copiez l'URL dans votre client torrent (rutorrent, qBittorrent, Transmission, etc). Les flux se mettent Ã  jour automatiquement.
            </div>
        </div>

        <!-- TAB: LOGS -->
        <div id="logs" class="tab-content">
            <h2>ğŸ“ Historique Synchronisations</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Statut</th>
                        <th>Grabs</th>
                        <th>Doublons</th>
                        <th>Erreur</th>
                    </tr>
                </thead>
                <tbody id="logs-table">
                    <tr><td colspan="5" style="text-align: center; color: #888;">Chargement...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- TAB: CONFIG -->
        <div id="config" class="tab-content">
            <h2>âš™ï¸ Configuration</h2>
            <div id="config-form"></div>
            <div style="margin-top: 20px;">
                <button class="button success" onclick="saveConfig()">ğŸ’¾ Sauvegarder</button>
                <button class="button" onclick="loadConfig()">ğŸ”„ Recharger</button>
            </div>
        </div>

        <!-- TAB: ADMIN (NOUVEAU v2.6.8) -->
        <div id="admin" class="tab-content">
            <h2>ğŸ”§ Administration & Maintenance</h2>
            
            <h3 style="margin-top: 20px; margin-bottom: 15px;">ğŸ“Š Statistiques SystÃ¨me</h3>
            <div class="grid">
                <div class="card">
                    <h3>Base de DonnÃ©es</h3>
                    <div class="value"><span id="admin-db-size">-</span><span class="unit">MB</span></div>
                    <p style="color: #888; font-size: 12px; margin-top: 10px;">
                        Grabs: <span id="admin-db-grabs">-</span> |
                        Logs: <span id="admin-db-logs">-</span>
                    </p>
                </div>
                <div class="card">
                    <h3>Fichiers Torrents</h3>
                    <div class="value"><span id="admin-torrent-count">-</span></div>
                    <p style="color: #888; font-size: 12px; margin-top: 10px;">
                        Taille: <span id="admin-torrent-size">-</span> MB<br>
                        Orphelins: <span id="admin-torrent-orphans" style="color: #ff6b6b;">-</span>
                    </p>
                </div>
                <div class="card">
                    <h3>MÃ©moire</h3>
                    <div class="value"><span id="admin-memory">-</span><span class="unit">MB</span></div>
                    <p style="color: #888; font-size: 12px; margin-top: 10px;">
                        CPU: <span id="admin-cpu">-</span>%
                    </p>
                </div>
                <div class="card">
                    <h3>Uptime</h3>
                    <div class="value" id="admin-uptime" style="font-size: 20px;">-</div>
                </div>
            </div>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px;">ğŸ› ï¸ Actions de Maintenance</h3>
            <div class="actions">
                <button class="button" onclick="loadAdminStats()">ğŸ”„ RafraÃ®chir Stats</button>
                <button class="button" onclick="clearCache()">ğŸ—‘ï¸ Vider Cache</button>
                <button class="button" onclick="vacuumDatabase()">ğŸ”§ Optimiser BD</button>
                <button class="button success" onclick="syncNow()">ğŸ“¡ Forcer Sync</button>
                <button class="button danger" onclick="purgeOldGrabs()">ğŸ—‘ï¸ Purger Anciens</button>
                <button class="button" onclick="testHistoryLimits()">ğŸ“Š Tester Limites Historique</button>
            </div>

            <div class="alert info" style="margin-top: 15px;">
                <strong>ğŸ’¡ Configuration :</strong>
                Vous pouvez modifier la configuration via l'onglet <strong>Configuration</strong>.
                Les paramÃ¨tres sont sauvegardÃ©s dans <strong>/config/settings.yml</strong>.
                Un redÃ©marrage peut Ãªtre nÃ©cessaire pour certains paramÃ¨tres (SYNC_INTERVAL, etc.).
            </div>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px;">ğŸ“‹ Logs de Synchronisation</h3>
            <div class="filter-bar">
                <label for="log-level-filter" style="margin: 0; color: #1e90ff; font-weight: 600;">Niveau:</label>
                <select id="log-level-filter" onchange="loadSystemLogs()" style="flex: 0 0 auto; min-width: 150px;">
                    <option value="all">Tous</option>
                    <option value="success">SuccÃ¨s</option>
                    <option value="error">Erreurs</option>
                    <option value="warning">Avertissements</option>
                    <option value="info">Informations</option>
                </select>
                <button class="button danger" onclick="purgeAllLogs()" style="margin-left: auto;">ğŸ—‘ï¸ Vider Tous les Logs</button>
            </div>
            <div id="system-logs-container" style="max-height: 500px; overflow-y: auto; margin-top: 15px;">
                <p style="text-align: center; color: #888; padding: 20px;">Chargement des logs...</p>
            </div>

            <div class="alert info" style="margin-top: 15px;">
                <strong>ğŸ’¡ Ã€ propos des logs :</strong>
                Les logs affichent l'historique des synchronisations avec Prowlarr. Chaque log contient le nombre de grabs rÃ©cupÃ©rÃ©s, les doublons dÃ©tectÃ©s et les Ã©ventuelles erreurs. Vous pouvez supprimer individuellement les logs ou vider tous les logs pour libÃ©rer de l'espace.
            </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">ğŸ“Š Test des Limites d'Historique</h3>
            <div id="history-test-results" style="display: none;">
                <div class="alert info" style="margin-bottom: 15px;">
                    <strong>ğŸ“ RÃ©sultats du test</strong><br>
                    <span id="history-test-timestamp" style="color: #888; font-size: 12px;"></span>
                </div>
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333;">
                    <pre id="history-test-content" style="margin: 0; white-space: pre-wrap; font-size: 12px; color: #ddd; max-height: 400px; overflow-y: auto;"></pre>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <a id="history-test-download" href="#" download="history_limits_test.json" class="button" style="text-decoration: none;">ğŸ’¾ TÃ©lÃ©charger JSON</a>
                </div>
            </div>
        </div>

        <!-- TAB: SÃ‰CURITÃ‰ -->
        <div id="security" class="tab-content">
            <h2>ğŸ” SÃ©curitÃ© & Authentification</h2>
            <p style="color: #888; margin-bottom: 20px;">GÃ©rez votre compte, votre mot de passe et vos API keys pour l'accÃ¨s aux flux RSS</p>

            <!-- Section: Compte -->
            <div class="card" style="margin-bottom: 30px;">
                <h3>ğŸ‘¤ Mon Compte</h3>
                <div style="margin-top: 15px;">
                    <p style="color: #888; margin-bottom: 10px;">
                        Utilisateur: <strong id="security-username" style="color: #1e90ff;">-</strong>
                    </p>
                    <div class="actions">
                        <button class="button" onclick="showChangePasswordForm()">ğŸ”‘ Changer le mot de passe</button>
                    </div>
                </div>

                <!-- Formulaire de changement de mot de passe -->
                <div id="change-password-form" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333;">
                    <h4 style="color: #1e90ff; margin-bottom: 15px;">Changer le mot de passe</h4>
                    <div class="form-group">
                        <label>Ancien mot de passe</label>
                        <input type="password" id="old-password" placeholder="Ancien mot de passe">
                    </div>
                    <div class="form-group">
                        <label>Nouveau mot de passe</label>
                        <input type="password" id="new-password" placeholder="Minimum 8 caractÃ¨res">
                    </div>
                    <div class="actions">
                        <button class="button success" onclick="changePassword()">âœ… Confirmer</button>
                        <button class="button" onclick="hideChangePasswordForm()">âŒ Annuler</button>
                    </div>
                </div>
            </div>

            <!-- Section: API Keys -->
            <div class="card">
                <h3>ğŸ”‘ API Keys</h3>
                <p style="color: #888; font-size: 13px; margin-bottom: 15px;">
                    Les API Keys permettent l'accÃ¨s aux flux RSS depuis l'extÃ©rieur du rÃ©seau local.
                    Ajoutez <code style="background: #0f0f0f; padding: 2px 6px; border-radius: 3px;">?api_key=VOTRE_CLE</code> Ã  l'URL du flux RSS.
                </p>

                <!-- CrÃ©ation d'API Key -->
                <div style="background: #0f0f0f; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #1e90ff; margin-bottom: 10px;">CrÃ©er une nouvelle API Key</h4>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <input type="text" id="api-key-name" placeholder="Nom de l'API Key (ex: qBittorrent)" style="width: 100%;">
                    </div>
                    <button class="button success" onclick="createApiKey()">â• CrÃ©er</button>
                </div>

                <!-- Liste des API Keys -->
                <div id="api-keys-list">
                    <p style="color: #888; text-align: center;">Chargement...</p>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="/static/js/app.js"></script>
{% endblock %}
