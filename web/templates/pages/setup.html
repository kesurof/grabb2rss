{% extends "base.html" %}

{% block title %}Configuration Initiale - Grabb2RSS{% endblock %}
{% block page_id %}setup{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/app.css?v={{ version }}">
{% endblock %}

{% block legacy_css %}{% endblock %}

{% block shell %}
    {{ self.content() }}
{% endblock %}

{% block content %}
    <div class="page-shell" data-first-run="{{ 'true' if first_run else 'false' }}" data-config-exists="{{ 'true' if config_exists else 'false' }}">
        <div class="page-header page-header--row">
            <div>
                <h1>Configuration initiale</h1>
                <p class="page-desc">Connectez vos services externes puis validez vos paramètres de base.</p>
            </div>
        </div>

        <div id="alert" class="alert"></div>
        <div id="loading" class="loading" data-role="loading">
            <div class="spinner"></div>
            <p class="section-note">Validation et sauvegarde en cours...</p>
        </div>

        <form id="setupForm">
            <div class="setup-wizard" data-step-total="4">
                <div class="setup-wizard__steps" aria-hidden="true">
                    <div class="setup-wizard__step" data-step-index="0">Services</div>
                    <div class="setup-wizard__step" data-step-index="1">Paramètres</div>
                    <div class="setup-wizard__step" data-step-index="2">Sécurité</div>
                    <div class="setup-wizard__step" data-step-index="3">Finalisation</div>
                </div>
                <div class="setup-wizard__progress">
                    <div class="setup-wizard__progress-bar" data-role="setup-progress"></div>
                </div>
                <div class="setup-wizard__meta" aria-hidden="true"></div>
            </div>

            <div class="page-section setup-step" data-setup-step="0">
                <div class="section-header">Services externes</div>
                <div class="section-note">Ajoutez les URL et clés API. Les valeurs par défaut sont prêtes pour un déploiement Docker.</div>

                <div class="setup-defaults-note">
                    <span class="setup-defaults-note__badge">Docker</span>
                    <span>Par défaut: <code>prowlarr</code>, <code>radarr</code>, <code>sonarr</code> en hostname réseau.</span>
                </div>

                <div class="section-grid">
                    <div class="service-card">
                        <div class="service-title"><span class="service-badge">PR</span>Prowlarr</div>
                        <div class="form-field">
                            <label class="form-label">URL <span class="required">*</span></label>
                            <input class="form-input" type="url" id="prowlarr_url" name="prowlarr_url"
                                   value="http://prowlarr:9696" placeholder="http://prowlarr:9696" required>
                            <div class="form-help">URL complète de l’instance (avec port).</div>
                        </div>
                        <div class="form-field">
                            <label class="form-label">Clé API <span class="required">*</span></label>
                            <input class="form-input" type="text" id="prowlarr_api_key" name="prowlarr_api_key"
                                   placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                            <div class="form-help">Prowlarr → Paramètres → Sécurité.</div>
                        </div>
                    </div>

                    <div class="service-card">
                        <div class="service-title"><span class="service-badge">RA</span>Radarr</div>
                        <div class="form-field">
                            <label class="form-label">URL <span class="required">*</span></label>
                            <input class="form-input" type="url" id="radarr_url" name="radarr_url"
                                   value="http://radarr:7878" placeholder="http://radarr:7878" required>
                            <div class="form-help">URL complète de l’instance.</div>
                        </div>
                        <div class="form-field">
                            <label class="form-label">Clé API <span class="required">*</span></label>
                            <input class="form-input" type="text" id="radarr_api_key" name="radarr_api_key"
                                   placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                            <div class="form-help">Radarr → Paramètres → Sécurité.</div>
                        </div>
                    </div>

                    <div class="service-card">
                        <div class="service-title"><span class="service-badge">SO</span>Sonarr</div>
                        <div class="form-field">
                            <label class="form-label">URL <span class="required">*</span></label>
                            <input class="form-input" type="url" id="sonarr_url" name="sonarr_url"
                                   value="http://sonarr:8989" placeholder="http://sonarr:8989" required>
                            <div class="form-help">URL complète de l’instance.</div>
                        </div>
                        <div class="form-field">
                            <label class="form-label">Clé API <span class="required">*</span></label>
                            <input class="form-input" type="text" id="sonarr_api_key" name="sonarr_api_key"
                                   placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                            <div class="form-help">Sonarr → Paramètres → Sécurité.</div>
                        </div>
                    </div>
                </div>
                <div class="actions-bar">
                    <button type="button" class="btn btn-secondary" data-action="test-connection">
                        Tester la connexion
                    </button>
                </div>
            </div>

            <div class="page-section setup-step" data-setup-step="1">
                <div class="section-header">Paramètres</div>
                <div class="section-grid">
                    <div class="service-card">
                        <div class="form-field">
                            <label class="form-label">Fenêtre de rattrapage history</label>
                            <input class="form-input" type="number" id="history_lookback_days" name="history_lookback_days" value="7" min="1" max="30">
                            <div class="form-help">Nombre de jours à analyser pour le rattrapage history (1 à 30).</div>
                        </div>
                        <div class="form-field">
                            <label class="form-label">Rétention torrents</label>
                            <input class="form-input" type="number" id="retention_hours" name="retention_hours" value="168">
                            <div class="form-help">Durée de conservation (168 = 7 jours).</div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="auto_purge" name="auto_purge" checked>
                            <label for="auto_purge" class="form-label" style="margin: 0;">Purge automatique des anciens torrents</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-section page-section--subtle setup-step" data-setup-step="2">
                <div class="section-header">Sécurité (recommandée)</div>
                <div class="section-note">Ajoutez une authentification pour protéger l’accès à l’interface.</div>

                <div class="auth-toggle">
                    <div class="auth-toggle__label">
                        <span class="auth-toggle__title">Activer l'authentification</span>
                        <span class="auth-toggle__note">Recommandée pour protéger l’accès</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="auth_enabled" name="auth_enabled" data-action="toggle-auth">
                        <span class="switch__track" aria-hidden="true"></span>
                        <span class="switch__thumb" aria-hidden="true"></span>
                    </label>
                </div>
                <div id="auth_fields" style="display: none;">
                    <div class="form-field">
                        <label class="form-label">Nom d'utilisateur <span class="required">*</span></label>
                        <input class="form-input" type="text" id="auth_username" name="auth_username"
                               placeholder="admin" autocomplete="username">
                        <div class="form-help">Identifiant de connexion.</div>
                    </div>
                    <div class="form-field">
                        <label class="form-label">Mot de passe <span class="required">*</span></label>
                        <input class="form-input" type="password" id="auth_password" name="auth_password"
                               placeholder="Mot de passe sécurisé" autocomplete="new-password">
                        <div class="form-help">Minimum 8 caractères.</div>
                    </div>
                </div>

                <div class="section-header" style="margin-top: 32px;">Webhook Grab</div>
                <div class="section-note">Recommandé pour récupérer uniquement les torrents réellement grab.</div>

                <div class="auth-toggle">
                    <div class="auth-toggle__label">
                        <span class="auth-toggle__title">Activer le webhook</span>
                        <span class="auth-toggle__note">Permet le flux Grab → Prowlarr → .torrent</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="webhook_enabled" name="webhook_enabled" checked>
                        <span class="switch__track" aria-hidden="true"></span>
                        <span class="switch__thumb" aria-hidden="true"></span>
                    </label>
                </div>

                <div class="form-field">
                    <div class="form-inline">
                        <label class="form-label" style="margin: 0;">Token webhook</label>
                        <div class="copy-field">
                            <input class="form-input" type="text" id="webhook_token" name="webhook_token" readonly>
                            <button class="btn btn-secondary" type="button" data-action="generate-webhook-token">Générer</button>
                        </div>
                    </div>
                    <div class="form-help">Le token est intégré automatiquement dans l’URL webhook à copier.</div>
                </div>

                <div class="setup-webhook-guide">
                    <div class="setup-webhook-guide__title">Guide rapide Radarr / Sonarr</div>
                    <div class="setup-webhook-guide__note">1) Utilisez d’abord <code>grabb2rss</code>. 2) Si le test échoue, utilisez <code>172.17.0.1</code>.</div>
                    <div class="setup-webhook-guide__steps">
                        <div class="setup-webhook-step">Paramètres → Connect → + → Webhook</div>
                        <div class="setup-webhook-step">Méthode: POST</div>
                        <div class="setup-webhook-step">Événement: On Grab</div>
                    </div>
                </div>

                <div class="form-field">
                    <div class="form-inline">
                        <label class="form-label" style="margin: 0;">URL Webhook (Docker: grabb2rss)</label>
                        <div class="copy-field">
                            <input class="form-input" type="text" id="webhook_url_primary" name="webhook_url_primary" readonly>
                            <button class="btn btn-secondary" type="button" data-action="copy-webhook-url-primary">Copier</button>
                        </div>
                    </div>
                </div>

                <div class="form-field">
                    <div class="form-inline">
                        <label class="form-label" style="margin: 0;">URL Webhook (fallback: 172.17.0.1)</label>
                        <div class="copy-field">
                            <input class="form-input" type="text" id="webhook_url_fallback" name="webhook_url_fallback" readonly>
                            <button class="btn btn-secondary" type="button" data-action="copy-webhook-url-fallback">Copier</button>
                        </div>
                    </div>
                </div>

                <details class="advanced-block">
                    <summary>Paramètres avancés webhook</summary>
                    <div class="advanced-block__content">
                        <div class="form-field">
                            <label class="form-label">Score minimum</label>
                            <input class="form-input" type="number" id="webhook_min_score" name="webhook_min_score" value="3" min="1" max="10">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="webhook_strict" name="webhook_strict" checked>
                            <label for="webhook_strict" class="form-label" style="margin: 0;">Mode strict (hash obligatoire)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="webhook_download" name="webhook_download" checked>
                            <label for="webhook_download" class="form-label" style="margin: 0;">Télécharger le .torrent via Prowlarr</label>
                        </div>
                    </div>
                </details>
            </div>

            <div class="page-section setup-step" data-setup-step="3">
                <div class="section-header">Finalisation</div>
                <div class="section-note">Validez la configuration et lancez la première synchronisation.</div>
                <div class="actions-bar">
                    <button type="button" class="btn btn-secondary" data-action="go-fix">
                        Corriger
                    </button>
                    <button type="submit" class="btn btn-primary" data-action="submit-setup">
                        Enregistrer et démarrer
                    </button>
                </div>
            </div>

            <div class="setup-wizard__actions" data-role="setup-wizard-actions">
                <button type="button" class="btn btn-secondary" data-action="prev-step">Retour</button>
                <button type="button" class="btn btn-primary" data-action="next-step">Continuer</button>
            </div>
        </form>

        <div class="section-note" style="text-align: center;">
            Version {{ version }}
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script src="/static/js/app.js"></script>
{% endblock %}
